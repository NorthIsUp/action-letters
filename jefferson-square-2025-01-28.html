<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // Title
        const LETTER_TITLE = `Urgent Concerns Regarding Jefferson Square Park`;

        // Default letter body
        const LETTER_BODY = `
            I am writing to express urgent concerns regarding the deteriorating conditions at Jefferson Square Park and the immediate surrounding area. Our community is experiencing serious safety and public health issues that require immediate attention and a comprehensive solutionâ€”not simply displacing these problems to other neighborhoods.

            Jefferson Square Park is surrounded by many schools and residential buildings. Sacred Heart and Millennium schools are located directly on the park and Rosa Parks Elementary is just a block away. Margaret S. Hayward Playground has many after school care activities and youth sports programs like soccer, soft ball, and skateboarding lessons. Established in 1850 it is one of San Francisco's oldest public spaces and has been a vital community gathering place for over 174 years. This historic park served as a refugee camp after the 1906 earthquake and was later immortalized in Alfred Hitchcock's classic film "Vertigo" giving it an earned spot in San Francisco's cultural heritage.

            The current situation presents immediate safety risks to residents, students, and park users. Residents have observed the following activities and conditions:

            - Organized drug trafficking operations during nighttime hours
            - Multiple break-ins and burglaries targeting nearby residences
            - Sidewalk fires and attempted arson of residential buildings
            - Groups blocking emergency exits and main entrances to buildings
            - Ongoing package theft from residential buildings
            - Discarded medical waste throughout the park
            - Human waste contamination
            - Excessive accumulation of trash and debris
            - Unsanitary conditions affecting park usability

            The current conditions have effectively rendered this public space unusable for its intended purpose and create unacceptable risks for our community. We urgently request:

            - A detailed action plan addressing these issues comprehensively
            - Timeline for implementation of safety measures
            - Coordination between SFPD, Recreation and Parks, and social services
            - Regular community updates on progress
            - Long-term strategies to prevent recurrence

            We recognize these challenges require a balanced approach that addresses both immediate safety concerns and underlying causes. However, the current situation is untenable and demands urgent action.

            Please provide information about your planned response to these issues. Our community stands ready to engage constructively in developing and implementing solutions.
            `;
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Letter Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .prose {
                @apply max-w-none;
            }
            .prose h1 {
                @apply text-3xl font-bold mb-4;
            }
            .prose h2 {
                @apply text-2xl font-semibold mb-3;
            }
            .prose h3 {
                @apply text-xl font-semibold mb-2;
            }
            .prose p {
                @apply mb-4;
            }
            .prose ul {
                @apply list-disc pl-5 mb-4;
            }
            .prose li {
                @apply mb-1;
            }
            .editable-section {
                @apply relative cursor-text border border-dashed border-gray-300 p-4 rounded-md hover:border-blue-400 transition-colors;
            }
            .editable-section::before {
                content: 'Click to edit';
                @apply absolute -top-3 right-2 text-sm text-gray-500 bg-white px-2;
            }
            .editable-section:focus-within::before {
                content: 'Editing...';
                @apply text-blue-500;
            }
            .editable-section textarea {
                @apply absolute inset-0 opacity-0 w-full h-full p-4;
            }
            .editable-section:focus-within {
                @apply ring-2 ring-blue-500 border-transparent;
            }
            .editable-section:focus-within .content {
                @apply opacity-30;
            }
            .editable-section:focus-within textarea {
                @apply opacity-100;
            }
        }
    </style>
    
    <script>
        // Initialize Showdown converter
        const converter = new showdown.Converter({
            tables: true,
            simplifiedAutoLink: true,
            strikethrough: true,
            tasklists: true
        });
    </script>
    
    <script>
        // Map of officials and their emails, grouped by category
        const OFFICIALS = {
            'Elected Officials': {
                'Mayor Daniel Lurie': { 
                    email: 'daniel.lurie@sfgov.org',
                    hidden: false,
                    defaultSelected: true
                },
                'Supervisor Connie Chan (D1)': { 
                    email: 'ChanStaff@sfgov.org',
                    phone: '(415) 554-7410',
                    fax: '(415) 554-5163',
                    hidden: false,
                    defaultSelected: false
                },
                'Supervisor Stephen Sherrill (D2)': { 
                    email: 'SherrillStaff@sfgov.org',
                    phone: '(415) 554-7752',
                    hidden: false,
                    defaultSelected: true
                },
                'Supervisor Danny Sauter (D3)': { 
                    email: 'SauterStaff@sfgov.org',
                    phone: '(415) 554-7450',
                    hidden: false,
                    defaultSelected: false
                },
                'Supervisor Joel Engardio (D4)': { 
                    email: 'EngardioStaff@sfgov.org',
                    phone: '(415) 554-7460',
                    fax: '(415) 554-5163',
                    hidden: false,
                    defaultSelected: false
                },
                'Supervisor Bilal Mahmood (D5)': { 
                    email: 'MahmoodStaff@sfgov.org',
                    phone: '(415) 554-7630',
                    hidden: false,
                    defaultSelected: true
                },
                'Supervisor Matt Dorsey (D6)': { 
                    email: 'DorseyStaff@sfgov.org',
                    phone: '(415) 554-7970',
                    fax: '(415) 554-5163',
                    hidden: false,
                    defaultSelected: false
                },
                'Supervisor Myrna Melgar (D7)': { 
                    email: 'MelgarStaff@sfgov.org',
                    phone: '(415) 554-6516',
                    fax: '(415) 554-5163',
                    hidden: false,
                    defaultSelected: false
                },
                'Supervisor Rafael Mandelman (D8)': { 
                    email: 'MandelmanStaff@sfgov.org',
                    phone: '(415) 554-6968',
                    fax: '(415) 554-5163',
                    hidden: false,
                    defaultSelected: true,
                    title: 'Board President'
                },
                'Supervisor Jackie Fielder (D9)': { 
                    email: 'FielderStaff@sfgov.org',
                    phone: '(415) 554-5144',
                    hidden: false,
                    defaultSelected: false
                },
                'Supervisor Shamann Walton (D10)': { 
                    email: 'WaltonStaff@sfgov.org',
                    phone: '(415) 554-7670',
                    fax: '(415) 554-5163',
                    hidden: false,
                    defaultSelected: false
                },
                'Supervisor Chyanne Chen (D11)': { 
                    email: 'ChenStaff@sfgov.org',
                    phone: '(415) 554-6975',
                    hidden: false,
                    defaultSelected: false
                }
            },
            'Department Heads': {
                'General Manager of Recs & Parks Phil Ginsburg': { 
                    email: 'phil.ginsburg@sfgov.org',
                    hidden: false,
                    defaultSelected: true
                },
                'SFPD Chief of Police': { 
                    email: 'SFPDchief@sfgov.org',
                    hidden: false,
                    defaultSelected: true
                }
            },
            'Departments': {
                'Recs & Parks': { 
                    email: 'rpdinfo@sfgov.org',
                    hidden: false,
                    defaultSelected: true
                },
                'Department of Public Health': { 
                    email: 'sfdph@sfgov.org',
                    hidden: false,
                    defaultSelected: true
                },
                'Department of Public Works': { 
                    email: 'dpw@sfgov.org',
                    hidden: false,
                    defaultSelected: true
                }
            }
        };

        // Helper function to clean template strings (like Python's cleandoc)
        function cleanDoc(str) {
            // Remove initial newline and find minimum indentation
            const lines = str.replace(/^\n/, '').split('\n');
            const minIndent = lines
                .filter(line => line.trim())
                .reduce((min, line) => Math.min(min, line.match(/^\s*/)[0].length), Infinity);
            
            // Remove the minimum indentation from each line and join back
            return lines
                .map(line => line.slice(minIndent))
                .join('\n')
                .trim();
        }

        // Now we can use it with our templates:
        const LETTER_HEADER = cleanDoc(`
            # ${LETTER_TITLE}
            {date}

            Dear {recipientTitles}:
        `);

        const LETTER_FOOTER = cleanDoc(`
            Sincerely,

            {signature}

            {email}

            {address_lines}

            Sent To:
            - {recipientEmails}
            {ccBlock}
        `);

        // Letter template
        const LETTER_TEMPLATE = `
            {LETTER_HEADER}

            {LETTER_BODY}

            {LETTER_FOOTER}
        `;

        const DEFAULT_LETTER_BODY = cleanDoc(LETTER_BODY);
    </script>
</head>
<body class="bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-6">Letter Editor</h1>
        
        <div class="lg:flex lg:gap-6 min-h-screen">
            <!-- Combined Editor/Preview Section -->
            <div class="bg-white rounded-lg shadow-md p-6 w-full">
                <div class="prose max-w-none" id="letterContainer">
                    <!-- Content will be rendered here by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Send Section -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Recipients:</label>
                <div class="space-y-2" id="recipientCheckboxes">
                    <!-- Checkboxes will be inserted here by JavaScript -->
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="signature" class="block text-sm font-medium text-gray-700 mb-1">Your Name:</label>
                    <input type="text" id="signature" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 invalid:border-red-500"
                        oninput="updateLetter()">
                </div>
                
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Your Email:</label>
                    <input type="email" id="email" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 invalid:border-red-500"
                        oninput="updateLetter()">
                    <div id="emailError" class="mt-1 text-sm text-red-600 hidden"></div>
                </div>

                <div class="md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-1">
                        Your Address: <span class="text-gray-500 text-xs">(optional)</span>
                    </label>
                    <div class="relative">
                        <input type="text" id="address"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Street address, City, State ZIP"
                            oninput="updateLetter()">
                        <div id="addressError" class="mt-1 text-sm text-red-600 hidden"></div>
                    </div>
                </div>
            </div>

            <button onclick="sendLetter()"
                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                Send Letter
            </button>
        </div>
    </div>

    <script>
        // Create checkboxes for recipients
        function createRecipientCheckboxes() {
            const container = document.getElementById('recipientCheckboxes');
            container.className = 'flex flex-wrap gap-x-8 gap-y-6';
            
            Object.entries(OFFICIALS).forEach(([category, officials]) => {
                const visibleOfficials = Object.entries(officials).filter(([_, info]) => !info.hidden);
                
                if (visibleOfficials.length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'min-w-[250px]';
                    
                    // Count selected recipients in this category
                    const selectedCount = visibleOfficials.filter(([_, info]) => info.defaultSelected).length;
                    
                    categoryDiv.innerHTML = `
                        <details>
                            <summary class="font-medium text-gray-900 mb-2 cursor-pointer hover:text-blue-600">
                                ${category} 
                                <span class="text-sm text-gray-500">(${selectedCount} selected)</span>
                            </summary>
                            <div class="space-y-2 ml-4">
                            </div>
                        </details>
                    `;
                    
                    const officialsContainer = categoryDiv.querySelector('div');
                    visibleOfficials.forEach(([name, info]) => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center';
                        div.innerHTML = `
                            <input type="checkbox" 
                                id="recipient-${name}" 
                                value="${name}"
                                ${info.defaultSelected ? 'checked' : ''}
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                onchange="updateLetter(); updateSelectedCount(this)">
                            <label for="recipient-${name}" 
                                class="ml-2 block text-sm text-gray-900">
                                ${name}
                                ${info.title ? `<span class="text-xs text-gray-500 ml-1">(${info.title})</span>` : ''}
                            </label>`;
                        officialsContainer.appendChild(div);
                    });
                    
                    container.appendChild(categoryDiv);
                }
            });
        }

        // Add this new function to update the selected count
        function updateSelectedCount(checkbox) {
            const categoryDetails = checkbox.closest('details');
            const summary = categoryDetails.querySelector('summary');
            const checkboxes = categoryDetails.querySelectorAll('input[type="checkbox"]');
            const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            const countSpan = summary.querySelector('span');
            countSpan.textContent = `(${selectedCount} selected)`;
        }

        function getSelectedRecipients() {
            const checkboxes = document.querySelectorAll('#recipientCheckboxes input[type="checkbox"]');
            const selected = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            return selected;
        }

        function getRecipientEmail(name) {
            // Search through each category for the official's email
            for (const category of Object.values(OFFICIALS)) {
                if (name in category) {
                    return category[name].email;
                }
            }
            return null;
        }

        function getCCEmails(recipients) {
            // Collect all CC emails from selected recipients
            const ccEmails = new Set();
            for (const name of recipients) {
                for (const category of Object.values(OFFICIALS)) {
                    if (name in category && category[name].cc) {
                        category[name].cc.forEach(email => ccEmails.add(email));
                    }
                }
            }
            return Array.from(ccEmails);
        }

        function getLetterTemplate(recipients, body, signature) {
            const date = new Date().toLocaleDateString();
            const recipientList = recipients.join('\n');
            const recipientTitles = recipients.length > 1 
                ? recipients.slice(0, -1).join(', ') + ' and ' + recipients.slice(-1)
                : recipients[0];

            return cleanDoc(LETTER_TEMPLATE)
                .replace('{LETTER_HEADER}', cleanDoc(LETTER_HEADER))
                .replace('{LETTER_BODY}', cleanDoc(body))
                .replace('{LETTER_FOOTER}', cleanDoc(LETTER_FOOTER))
                .replace('{date}', date)
                .replace('{recipients}', recipientList)
                .replace('{recipientTitles}', recipientTitles)
                .replace('{signature}', cleanDoc(signature))
                .replace('{email}', document.getElementById('email').value)
                .replace('{cc}', getCCEmails(recipients).join(', '));
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validateForm() {
            const signature = document.getElementById('signature').value.trim();
            const email = document.getElementById('email').value.trim();
            const emailError = document.getElementById('emailError');
            
            let isValid = true;

            if (!signature) {
                document.getElementById('signature').classList.add('invalid');
                isValid = false;
            } else {
                document.getElementById('signature').classList.remove('invalid');
            }

            if (!email) {
                emailError.textContent = 'Email is required';
                emailError.style.display = 'block';
                isValid = false;
            } else if (!validateEmail(email)) {
                emailError.textContent = 'Please enter a valid email address';
                emailError.style.display = 'block';
                isValid = false;
            } else {
                emailError.style.display = 'none';
            }

            return isValid;
        }

        function sendLetter() {
            if (!validateForm()) {
                alert('Please fill in all required fields correctly before sending.');
                return;
            }

            const recipients = getSelectedRecipients();
            if (recipients.length === 0) {
                alert('Please select at least one recipient.');
                return;
            }

            const body = document.getElementById('letterBody').value;
            const signature = document.getElementById('signature').value;
            const email = document.getElementById('email').value;
            const address = document.getElementById('address').value;
            
            // Get main recipient emails
            const recipientEmails = recipients
                .map(name => getRecipientEmail(name))
                .filter(email => email)
                .join(',');
            
            // Get CC emails as a comma-separated string
            const ccEmails = getCCEmails(recipients).join(',');
            
            // Format recipient emails for the template
            const recipientEmailsFormatted = recipients
                .map(name => getRecipientEmail(name))
                .filter(email => email)
                .join('\n - ');

            // Get CC addresses for the template
            const ccAddresses = getCCEmails(recipients);
            const ccBlock = ccAddresses.length > 0 ? `\n\nCC:\n- ${ccAddresses.join('\n- ')}` : '';

            // Format the complete letter with all replacements
            const fullLetter = cleanDoc(LETTER_TEMPLATE)
                .replace('{LETTER_HEADER}', cleanDoc(LETTER_HEADER)
                    .replace('{date}', new Date().toLocaleDateString())
                    .replace('{recipientTitles}', recipients.length > 1 
                        ? recipients.slice(0, -1).join(', ') + ' and ' + recipients.slice(-1)
                        : recipients[0]))
                .replace('{LETTER_BODY}', cleanDoc(body))
                .replace('{LETTER_FOOTER}', cleanDoc(LETTER_FOOTER)
                    .replace('{signature}', signature)
                    .replace('{email}', email)
                    .replace('{address_lines}', address ? address.split(',').map(line => line.trim()).join('\n') : '')
                    .replace('{recipientEmails}', recipientEmailsFormatted)
                    .replace('{ccBlock}', ccBlock));
            
            // Build mailto link with CC field
            const mailtoLink = `mailto:${recipientEmails}${ccEmails ? `?cc=${ccEmails}` : ''}${
                ccEmails ? '&' : '?'
            }subject=${encodeURIComponent(LETTER_TITLE)}&body=${encodeURIComponent(fullLetter)}`;
            
            window.location.href = mailtoLink;
        }

        // Add new function to render the letter container
        function renderLetterContainer(recipients, signature, email) {
            const container = document.getElementById('letterContainer');
            const address = document.getElementById('address').value;
            
            // Format recipient emails once for both header and footer
            const recipientEmailsFormatted = recipients
                .map(name => getRecipientEmail(name))
                .filter(email => email)
                .join('\n - ');

            // Get CC addresses
            const ccAddresses = getCCEmails(recipients);
            const ccBlock = ccAddresses.length > 0 ? `\n\nCC:\n- ${ccAddresses.join('\n- ')}` : '';

            // Format address lines
            function formatAddress(address) {
                if (!address) return '';
                // Split address by commas and format each line
                return address.split(',')
                    .map(line => line.trim())
                    .join('\n');
            }

            // Replace template variables in header and footer
            const headerHtml = converter.makeHtml(
                LETTER_HEADER
                    .replace('{date}', new Date().toLocaleDateString())
                    .replace('{recipientEmails}', recipientEmailsFormatted)
                    .replace('{recipientTitles}', recipients.length > 1 
                        ? recipients.slice(0, -1).join(', ') + ' and ' + recipients.slice(-1)
                        : recipients[0] || '[Recipients]')
            );

            const footerHtml = converter.makeHtml(
                LETTER_FOOTER
                    .replace('{signature}', signature || '[Your Name]')
                    .replace('{email}', email || '[Your Email]')
                    .replace('{address_lines}', formatAddress(address))
                    .replace('{recipientEmails}', recipientEmailsFormatted)
                    .replace('{ccBlock}', ccBlock)
            );

            container.innerHTML = `
                ${headerHtml}

                <div class="editable-section">
                    <div class="content" id="letterPreview"></div>
                    <textarea id="letterBody" 
                        oninput="updateLetter()"
                        placeholder="Write your letter here..."></textarea>
                </div>

                ${footerHtml}
            `;

            // Restore the textarea value if it exists
            const textarea = document.getElementById('letterBody');
            if (textarea && !textarea.value) {
                textarea.value = DEFAULT_LETTER_BODY;
            }
        }

        function updateLetter() {
            const recipients = getSelectedRecipients();
            const body = document.getElementById('letterBody').value;
            const signature = document.getElementById('signature').value || '[Your Name]';
            const email = document.getElementById('email').value || '[Your Email]';
            
            // Only update the preview content
            document.getElementById('letterPreview').innerHTML = converter.makeHtml(body);
            
            // Update recipient and signature sections without touching the editable section
            const container = document.getElementById('letterContainer');
            const address = document.getElementById('address').value;
            
            const recipientEmailsFormatted = recipients
                .map(name => getRecipientEmail(name))
                .filter(email => email)
                .join('\n - ');
            
            const ccAddresses = getCCEmails(recipients);
            const ccBlock = ccAddresses.length > 0 ? `\n\nCC:\n- ${ccAddresses.join('\n- ')}` : '';
            
            // Format address lines
            function formatAddress(address) {
                if (!address) return '';
                // Split address by commas and format each line
                return address.split(',')
                    .map(line => line.trim())
                    .join(', ');
            }

            // Update header
            const headerHtml = converter.makeHtml(
                LETTER_HEADER
                    .replace('{date}', new Date().toLocaleDateString())
                    .replace('{recipientEmails}', recipientEmailsFormatted)
                    .replace('{recipientTitles}', recipients.length > 1 
                        ? recipients.slice(0, -1).join(', ') + ' and ' + recipients.slice(-1)
                        : recipients[0] || '[Recipients]')
            );
            
            // Update footer
            const footerHtml = converter.makeHtml(
                LETTER_FOOTER
                    .replace('{signature}', signature || '[Your Name]')
                    .replace('{email}', email || '[Your Email]')
                    .replace('{address_lines}', formatAddress(address))
                    .replace('{recipientEmails}', recipientEmailsFormatted)
                    .replace('{ccBlock}', ccBlock)
            );
            
            // Split the container's children into header, editable section, and footer
            const editableSection = container.querySelector('.editable-section');
            
            // Replace everything before the editable section (header)
            while (container.firstChild !== editableSection) {
                container.removeChild(container.firstChild);
            }
            container.insertAdjacentHTML('afterbegin', headerHtml);
            
            // Replace everything after the editable section (footer)
            while (container.lastChild !== editableSection) {
                container.removeChild(container.lastChild);
            }
            container.insertAdjacentHTML('beforeend', footerHtml);
        }

        function saveUserData() {
            const signature = document.getElementById('signature').value.trim();
            const email = document.getElementById('email').value.trim();
            const address = document.getElementById('address').value.trim();
            
            if (signature) localStorage.setItem('user_signature', signature);
            if (email) localStorage.setItem('user_email', email);
            if (address) localStorage.setItem('user_address', address);
        }

        function loadUserData() {
            const signature = localStorage.getItem('user_signature');
            const email = localStorage.getItem('user_email');
            const address = localStorage.getItem('user_address');
            
            if (signature) document.getElementById('signature').value = signature;
            if (email) document.getElementById('email').value = email;
            if (address) document.getElementById('address').value = address;
            
            // Update the letter with loaded data
            if (signature || email || address) {
                updateLetter();
            }
        }

        // Modify the input handlers to save data
        document.getElementById('signature').addEventListener('input', function() {
            updateLetter();
            saveUserData();
        });

        document.getElementById('email').addEventListener('input', function() {
            updateLetter();
            saveUserData();
        });

        document.getElementById('address').addEventListener('input', function() {
            updateLetter();
            saveUserData();
        });

        // Modify the window load event to load saved data
        window.addEventListener('load', function() {
            createRecipientCheckboxes();
            renderLetterContainer(getSelectedRecipients(), '', '');
            document.getElementById('letterBody').value = DEFAULT_LETTER_BODY;
            loadUserData(); // Load saved user data
            updateLetter();
        });
    </script>
</body>
</html> 
